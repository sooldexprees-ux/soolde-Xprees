<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تأكيد الدفع - Soold Express</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f8fafc; overflow-x: hidden; }
        
        /* تصميم التنبيه العائم (Error Toast) */
        #errorToast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: #1f1f1f; color: white;
            padding: 16px; border-radius: 20px; border-right: 6px solid #ef4444;
            display: flex; align-items: center; justify-content: space-between;
            z-index: 9999; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        #errorToast.show { top: 20px; }

        .premium-card { background: white; border-radius: 40px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08); border: 1px solid #f1f5f9; }
        
        .input-field { width: 100%; background: #f8fafc; border: 2px solid #f1f5f9; border-radius: 20px; padding: 16px 48px 16px 16px; font-weight: 700; transition: 0.3s; outline: none; }
        .input-field:focus { border-color: #2563eb; background: white; }
        
        .upload-box { border: 2px dashed #cbd5e1; border-radius: 28px; padding: 30px; text-align: center; cursor: pointer; background: #fbfcfe; transition: 0.3s; position: relative; overflow: hidden; min-height: 160px; display: flex; align-items: center; justify-content: center; }
        #previewImage { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 10; }

        /* الزر الذكي وحالاته */
        .btn-confirm { 
            width: 100%; height: 65px; background: #1e3a8a; color: white; border-radius: 22px; 
            font-weight: 900; font-size: 18px; transition: 0.4s; position: relative; overflow: hidden;
        }
        .loading-spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* انيميشن الاهتزاز عند الخطأ */
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <div id="errorToast">
        <div class="flex items-center gap-3">
            <span class="bg-red-500/20 p-2 rounded-xl text-red-500">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </span>
            <span id="errorMsg" class="font-bold text-sm"></span>
        </div>
    </div>

    <div class="premium-card w-full max-w-[450px] p-8 text-right" id="mainCard">
        <h2 class="text-2xl font-black text-slate-900 mb-8 text-center">تأكيد عملية الدفع</h2>

        <div class="space-y-6">
            <div>
                <label class="block text-[11px] font-black text-slate-400 mb-2 mr-2 uppercase">مُعرف الحساب (USER ID)</label>
                <div class="relative">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    </span>
                    <input type="text" id="user" class="input-field" placeholder="أدخل ID الحساب أولاً">
                </div>
            </div>

            <div>
                <label class="block text-[11px] font-black text-slate-400 mb-2 mr-2 uppercase">المبلغ المدفوع (MAD)</label>
                <div class="relative">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-sm">DH</span>
                    <input type="number" id="monton" class="input-field" placeholder="0.00" style="padding-right: 55px;">
                </div>
            </div>

            <div>
                <label class="block text-[11px] font-black text-slate-400 mb-2 mr-2 uppercase">وصل التحويل</label>
                <div class="upload-box" onclick="document.getElementById('imageFile').click()">
                    <div id="uploadContent">
                        <svg class="w-8 h-8 mx-auto text-blue-500 mb-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <p class="text-sm font-bold text-slate-600">إرفاق صورة الوصل</p>
                    </div>
                    <img id="previewImage">
                </div>
                <input type="file" id="imageFile" accept="image/*" class="hidden">
            </div>
        </div>

        <button id="submitBtn" class="btn-confirm mt-10 flex items-center justify-center">
            <span id="btnSpinner" class="loading-spinner mr-3"></span>
            <span id="btnText">إرسال الطلب الآن</span>
        </button>

        <p class="text-center text-[10px] font-black text-slate-300 mt-8 tracking-widest uppercase">Soold Express Secure</p>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const platform = urlParams.get('platform') || localStorage.getItem('selectedPlatform') || "General";
        const symbol = urlParams.get('symbol') || "N/A";

        const toast = document.getElementById('errorToast');
        const errorMsg = document.getElementById('errorMsg');
        const card = document.getElementById('mainCard');

        function showError(msg) {
            errorMsg.innerText = msg;
            toast.classList.add('show');
            card.classList.add('shake');
            if(window.navigator.vibrate) window.navigator.vibrate(200);
            setTimeout(() => {
                toast.classList.remove('show');
                card.classList.remove('shake');
            }, 3500);
        }

        document.getElementById('imageFile').onchange = function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('previewImage');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById('uploadContent').style.visibility = 'hidden';
                };
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('submitBtn').onclick = async function() {
            const user = document.getElementById('user').value;
            const monton = document.getElementById('monton').value;
            const fileInput = document.getElementById('imageFile');
            const btn = this;
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');

            // التحقق من البيانات بنفس منطق صورك
            if (!user) { showError("المرجو إدخال ID الحساب أولاً"); return; }
            if (!monton) { showError("المرجو تحديد المبلغ المرسل"); return; }
            if (fileInput.files.length === 0) { showError("يرجى إرفاق صورة الوصل للمتابعة"); return; }

            // حالة التحميل
            btn.disabled = true;
            btn.style.background = "#0f172a";
            btnSpinner.style.display = "block";
            btnText.innerText = "جاري التأمين والرفع...";

            try {
                // 1. رفع الصورة
                const imgFormData = new FormData();
                imgFormData.append('image', fileInput.files[0]);
                const imgbbRes = await fetch(`https://api.imgbb.com/1/upload?key=B3817d05e64c4b61d823fb615461bd9e`, {
                    method: 'POST', body: imgFormData
                });
                const imgData = await imgbbRes.json();

                // 2. إرسال لجدول البيانات
                const scriptURL = 'https://script.google.com/macros/s/AKfycbzsznxacujJejhi1K9WPUlGAdJ3vCp2OVDIZ8krTB4mnif1LLKH_4ZvZaHRh3cnjaum/exec';
                await fetch(scriptURL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({
                        platforme: platform, user: user,
                        monton: monton + " DH", image: imgData.data.url, symbol: symbol
                    })
                });

                // حالة النجاح (تغيير الزر)
                btnSpinner.style.display = "none";
                btn.style.background = "#059669";
                btnText.innerText = "✓ تم إرسال طلبك بنجاح!";
                
                setTimeout(() => { window.location.href = "index.html"; }, 2500);

            } catch (err) {
                showError("فشل الاتصال! تأكد من جودة الإنترنت");
                btn.disabled = false;
                btn.style.background = "#1e3a8a";
                btnSpinner.style.display = "none";
                btnText.innerText = "إرسال الطلب الآن";
            }
        };
    </script>
</body>
</html>
